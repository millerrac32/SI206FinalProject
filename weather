import requests
import sqlite3
import matplotlib.pyplot as plt


DB_NAME = "open_meteo.db"


def create_tables(conn):
   cur = conn.cursor()
   cur.execute("""
   CREATE TABLE IF NOT EXISTS locations (
       location_id INTEGER PRIMARY KEY AUTOINCREMENT,
       city_name TEXT,
       latitude REAL,
       longitude REAL,
       UNIQUE(latitude, longitude)
   );
   """)
   cur.execute("""
   CREATE TABLE IF NOT EXISTS hourly_weather (
       weather_id INTEGER PRIMARY KEY AUTOINCREMENT,
       location_id INTEGER,
       time_utc TEXT,
       temperature_2m REAL,
       precipitation REAL,
       FOREIGN KEY(location_id) REFERENCES locations(location_id),
       UNIQUE(location_id, time_utc)
   );
   """)
   conn.commit()

def get_or_create_location(conn, city_name, latitude, longitude):
   cur = conn.cursor()
   cur.execute("""
       SELECT location_id
       FROM locations
       WHERE latitude = ? AND longitude = ?
   """, (latitude, longitude))
   row = cur.fetchone()
   if row:
       return row[0]
   cur.execute("""
       INSERT INTO locations (city_name, latitude, longitude)
       VALUES (?, ?, ?)
   """, (city_name, latitude, longitude))
   conn.commit()
   return cur.lastrowid

def fetch_open_meteo_data(latitude, longitude, start_date, end_date):
   base_url = "https://api.open-meteo.com/v1/forecast"
   params = {
       "latitude": latitude,
       "longitude": longitude,
       "start_date": start_date,
       "end_date": end_date,
       "hourly": "temperature_2m,precipitation",
       "timezone": "UTC"
   }
   response = requests.get(base_url, params=params)
   response.raise_for_status()
   data = response.json()
   return data

def store_hourly_data(conn, location_id, weather_data):
   cur = conn.cursor()
   hourly_timestamps = weather_data["hourly"]["time"]
   temperatures = weather_data["hourly"]["temperature_2m"]
   precipitations = weather_data["hourly"]["precipitation"]
   rows_inserted = 0
   for i in range(len(hourly_timestamps)):
       if rows_inserted >= 25:
           break
       time_utc = hourly_timestamps[i]
       temp = temperatures[i]
       precip = precipitations[i]
       try:
           cur.execute("""
               INSERT OR IGNORE INTO hourly_weather (location_id, time_utc, temperature_2m, precipitation)
               VALUES (?, ?, ?, ?)
           """, (location_id, time_utc, temp, precip))
           if cur.rowcount > 0:
               rows_inserted += 1
       except sqlite3.IntegrityError:
           pass
   conn.commit()
   print(f"Inserted {rows_inserted} new hourly rows for location_id={location_id}.")